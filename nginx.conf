load_module modules/ngx_http_brotli_filter_module.so;
load_module modules/ngx_http_brotli_static_module.so;

daemon off;
user nginx nginx;
worker_processes 1;
error_log stderr warn;
worker_rlimit_nofile 8192;
pid /var/run/nginx.pid;

events {
  worker_connections  1024;
}

http {
  include /etc/nginx/mime.types;
  sendfile on;
  tcp_nopush on;
  gzip_static on;
  brotli_static on;
  port_in_redirect off;
  server_name_in_redirect off;

  # Redirects
  map_hash_bucket_size 256;
  map $request_uri $new_uri {
    default "";
    /enterprise /;
    /contribution-guidelines/contributing /;
    /devops/how-to-do-a-load-test /operations/maintenance/how-to-do-a-load-test/;
    /devops/how-to-varnish /operations/maintenance/how-to-varnish/;
    /devops/self-hosting /operations/self-hosting/;
    /devops/self-hosting/access-private-npm-modules /operations/npm/access-private-npm-modules/;
    /devops/self-hosting/docker /operations/docker/;
    /devops/self-hosting/docker/build-docker-images /operations/docker/build-docker-images/;
    /devops/self-hosting/external-services /operations/external-services/;
    /devops/self-hosting/hardware-requirements /operations/hardware-requirements/;
    /devops/self-hosting/high-availability /operations/high-availability/;
    /devops/self-hosting/high-availability/high-availability-setup /operations/high-availability-setup/;
    /devops/self-hosting/proxy /operations/proxy/;
    /evaluation-guide/create_designs /guides/documents/document-design/document-design-intro;
    /evaluation-guide/dictionary /evaluation/glossary/;
    /evaluation-guide/getting_started /evaluation/getting-started/;
    /evaluation-guide/getting-started-with-local-development /evaluation/system-requirements/;
    /evaluation-guide/image-services /guides/media-library/image-services/;
    /evaluation-guide/intro /reference-docs/includes/;
    /evaluation-guide/metadata-examples /guides/documents/metadata/metadata-examples/;
    /guides/access/access_hooks /guides/access/access-hooks/;
    /guides/access/access_rights /guides/authentication/access-rights/;
    /guides/github-login /guides/authentication/github-login/;
    /guides/imports/dpa-import /guides/integrations/dpa-import/;
    /guides/imports/import-legacy-system-documents /guides/integrations/import-legacy-system-documents/;
    /guides/includes-embeds/article_and_list_includes /guides/documents/includes/embedded-teaser-and-list/;
    /guides/includes-embeds/article_teasers /guides/documents/includes/document-teasers/;
    /guides/includes-embeds/embedded_documents /guides/documents/includes/editable-document-teasers/;
    /guides/includes-embeds/twitter_include_embed /guides/documents/includes/twitter-embed/;
    /guides/includes-embeds/youtube_include /guides/documents/includes/youtube-embed/;
    /guides/media_library /guides/media-library/media-library-setup/;
    /guides/push_notifications /guides/editor/push-notifications/;
    /guides/register_custom_dashboard_filters_ /guides/editor/custom-dashboard-filters/;
    /guides/setup_multilanguage /guides/editor/multi-language/;
    /guides/watching_documents /guides/editor/notifications/;
    /guides/workflows/add-custom-proofreading-task /guides/editor/proofreading-task/;
    /guides/workflows/add-custom-realtime-proofreading-dashboard /guides/editor/proofreading-dashboard/;
    /guides/workflows/add-custom-task /guides/editor/review-task/;
    /guides/workflows/enable-soft-lock /guides/editor/document-soft-lock/;
    /reference-docs/content-model/component_model /reference-docs/content-model/component/;
    /reference-docs/content-model/component_tree /reference-docs/content-model/component-tree/;
    /reference-docs/content-model/livingdoc /reference-docs/content-model/livingdocs-api/;
    /reference-docs/editor-config/default_dashboard_filter /reference-docs/editor-configuration/default-dashboard-filter/;
    /reference-docs/editor-config/editing-features /reference-docs/editor-configuration/editing-features/;
    /reference-docs/editor-config/image-cropping /reference-docs/editor-configuration/image-cropping/;
    /reference-docs/editor-config/image-source-policy /reference-docs/editor-configuration/image-source-policy/;
    /reference-docs/editor-config/login /reference-docs/editor-configuration/login/;
    /reference-docs/editor-config/menu-and-dashboards /reference-docs/editor-configuration/menu-and-dashboards/;
    /reference-docs/editor-config/metadata /reference-docs/editor-configuration/metadata/;
    /reference-docs/editor-config/text-editing /reference-docs/editor-configuration/text-editing/;
    /reference-docs/includes/editor_customization /reference-docs/includes/editor-customization/;
    /reference-docs/includes/server_customization /reference-docs/includes/server-customization/;
    /reference-docs/includes/service_multiselect /reference-docs/includes/service-multiselect/;
    /reference-docs/initalization /reference-docs/editor-api/;
    /reference-docs/initalization/document-drag-drop /reference-docs/editor-api/document-drag-drop/;
    /reference-docs/initalization/vue-component-registry /reference-docs/editor-api/vue-component-registry/;
    /reference-docs/project-config /reference-docs/project-config/project-config/;
    /reference-docs/project-config/content_types /reference-docs/project-config/content-types/;
    /reference-docs/project-config/editor_settings /reference-docs/project-config/editor-settings/;
    /reference-docs/project-config/media_types /reference-docs/project-config/media-types/;
    /reference-docs/server-code-apis/data_source_api /reference-docs/server-api/data-source-api/;
    /reference-docs/server-code-apis/events /reference-docs/server-api/events/;
    /reference-docs/server-code-apis/hooks /reference-docs/server-api/hooks/;
    /reference-docs/server-code-apis/import_api /reference-docs/server-api/import-api/;
    /reference-docs/server-code-apis/metadata /reference-docs/server-api/metadata/;
    /reference-docs/server-code-apis/seed_api /reference-docs/server-api/seed-api/;
    /reference-docs/server-config /reference-docs/server-configuration/;
    /reference-docs/server-config/config /reference-docs/server-configuration/;
    /reference-docs/server-config/custom-index /reference-docs/server-configuration/indexing/custom-index/;
    /reference-docs/server-config/google-cloud-storage /reference-docs/server-configuration/google-cloud-storage/;
    /reference-docs/server-config/logging /reference-docs/server-configuration/logging/;
    /reference-docs/server-config/publication-index /reference-docs/server-configuration/indexing/publication-index/;
    /reference-docs/server-config/server-initalization /reference-docs/server-configuration/server-initalization/;
    /reference-docs/server-config/single_sign-on /reference-docs/server-configuration/single-sign-on/;
    /reference-docs/server-config/teaser-preview-config /reference-docs/server-configuration/teaser-preview-config/;
    /reference-docs/server-config/webhooks /reference-docs/server-configuration/webhooks/;
    /reference/base_filter /reference-docs/editor-configuration/base-filter/;
    /reference/display_filter /reference-docs/editor-configuration/display-filter/;
    /reference/legacy-design-v1/design_config_v1 /reference-docs/project-config/legacy-design/design-config-v1/;
    /reference/legacy-design-v1/design_config_v1_to_v2 /reference-docs/project-config/legacy-design/design-config-v1-to-v2/;
    /reference/media-source-example /reference-docs/project-config/media-sources/;
    /reference/query-builder-plugin-implementation /reference-docs/server-configuration/query-builder-plugin-implementation/;
    /reference/storage-strategy-configuration /reference-docs/server-configuration/storage/;
    /enterprise/reference-docs/server-api/events /reference-docs/server-api/events/;
    /enterprise/reference-docs/server-configuration/webhooks /reference-docs/server-configuration/webhooks/;
    /enterprise/reference-docs/editor-api /reference-docs/editor-api/;
    /enterprise/guides/media-library/ /guides/media-library/media-library-setup/;
    /enterprise/reference-docs/editor-configuration /reference-docs/editor-configuration/;
    /enterprise/reference-docs/editor-configuration/text-editing /reference-docs/editor-configuration/text-editing/;
    /enterprise/guides/elasticsearch-indexing/custom-index /guides/search/custom-index/;
    /enterprise/guides/sitemaps-and-feeds /guides/organisation/sitemaps-and-feeds/;
    /enterprise/guides/auth /guides/authentication/;
  }

  server {
    listen 8080;
    access_log /dev/stdout;
    root /app/public;

    if ($new_uri != "") {
      rewrite ^(.*)$ $new_uri;
    }

    index index.html;
    error_page 404 /404.html;
  }
}
